<!--
// Javascript bughouse viewer v 1.01 (C) Sergiy Vasylkevych aka Fermy on FICS
// Feel free to use/copy/modify/distribute
// This update 02.21.2002
//-->

<!--
// I tried to modify it as less as possible
// I made the part that feeds it with chess.com games
// Pieces and things are from https://bughousedb.com/
// No idea about the rights -- bmacho
//
// last modification: 04.19.2021
//-->

<script type="text/javascript" src="bug.js"></script>

<script src="jquery-3.5.1.min.js" ></script>

<script src="chesscom_movelist_parse.js" ></script>

<script src="generate_bpgn.js" ></script>


<script>
var searchParams = new URLSearchParams(window.location.search)

var flip = (searchParams.get('flip') == "true" ) ? 'flip' :'noflip'
</script>

<script type="text/javascript">
<!--
Init();

v1=new game("v1","", "","", "", "playb", "", "gif2/", 40, "silver",flip);//-->
</script>

<body>
<textarea id="pasteHere" style="
position: absolute;
border-radius: 25px;
width: 70%;
height: 30%;
top: 15%;
left: 15%;
text-align: center; vertical-align: middle;
font-size: 4em;
display: table-cell; 
contenteditable='true';
visibility: hidden;
"> Paste the chess.com game link here! </textarea>

</body>


<script>

function handlePaste (e) {
	
	document.body.removeEventListener('paste', handlePaste);
	var clipboardData, pastedData;

	// Stop data actually being pasted into div
	e.stopPropagation();
	e.preventDefault();

	// Get pasted data via clipboard API
	clipboardData = e.clipboardData || window.clipboardData;
	pastedData = clipboardData.getData('Text');

	// Remove the textarea
	document.getElementById('pasteHere').remove()

	// Do whatever with pasteddata
	main( numbers_in_string(pastedData) )
}

function numbers_in_string (s) {
	return s.match(/\d/g).join('')}


document.getElementById('pasteHere').addEventListener('paste', handlePaste)
document.body.addEventListener('paste', handlePaste)

var gameA, gameB, movesA, movesB

function main (game_id) {
	// change the url: 	
	var queryParams = new URLSearchParams(window.location.search);
	queryParams.set("game_id", game_id);
	history.replaceState(null, null, "?"+queryParams.toString());

	proxyurl = "https://api.allorigins.win/raw?url="
	// browser can't call the chess.com callback url directly bc of CORS restrictions
	// so we use a random proxy provided by allorigins.win 
	
	gameurl = "https://www.chess.com/callback/live/game/" // https://www.chess.com/callback/live/game/[GAME_ID] where the data lives 

	$.getJSON( proxyurl + gameurl + game_id, function( json_reply ) {
		gameA = json_reply;

		gameB_id = gameA.game.partnerGameId

		$.getJSON( proxyurl + gameurl + gameB_id, function( json_reply ) {
			gameB = json_reply;
					
			movesA = parseMoveList(gameA.game.moveList)
			movesB = parseMoveList(gameB.game.moveList)

			var bpgn1

			bpgn1 = bpgn(gameA, gameB, movesA, movesB)
			
			console.log(bpgn1)

			v1.reloadgame(bpgn1, "", "")
			assforward(999,'c','v1',0)
		});	
	});
}

if ( searchParams.has('game_id') ) {
		main( numbers_in_string( searchParams.get("game_id") ) )
	} else {
		document.getElementById("pasteHere").style.visibility = "visible"
		document.getElementById('pasteHere').addEventListener('paste', handlePaste)
		document.body.addEventListener('paste', handlePaste)
	}

</script>

<script>
	// up/down arrow to start/end
	document.addEventListener('keydown', function( e ){
		if (e.keyCode == "38") assundomove(999,'c','v1');  //up
		if (e.keyCode == "40") assforward(999,'c','v1',0);   //down
	});

	// left/right arrows go back and forth
	var inter = -1;
	var HOP = 60; //miliseconds

	window.onkeydown = function( e ){
		 if(inter == -1){
			  inter = setInterval(function(){
					if (e.keyCode == "39") assforward(1,'c','v1',0);
					if (e.keyCode == "37") assundomove(1,'c','v1');
			  }, HOP)
		 }
	}
	window.onkeyup = function(){
		 clearInterval(inter)
		 inter = -1
	}

	// disable right click
	document.addEventListener('contextmenu', event => event.preventDefault());
</script>

<br>

<style>

	#forkongithub a{background:#083;color:#fff;text-decoration:none;font-family:arial,sans-serif;text-align:center;font-weight:bold;padding:5px 40px;font-size:1rem;line-height:2rem;position:relative;transition:0.5s;}

	#forkongithub a:hover{background:#c11;color:#fff;}

	#forkongithub a::before,#forkongithub a::after{content:"";width:100%;display:block;position:absolute;top:1px;left:0;height:1px;background:#fff;}

	#forkongithub a::after{bottom:1px;top:auto;}

	#forkongithub {width:1010px; padding: 0; margin:0; border:none; text-align:center;}

</style>

<div id='forkongithub'> 
	
	<a href="https://github.com/bmacho/bughouse-viewer">Fork me on GitHub</a>
	
</div>
